name: Azure CI/CD Pipeline

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.1.0, etc.)
    branches:
      - main  # Also trigger on main branch pushes (optional, for testing)

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  ACR_NAME: ${{ secrets.ACR_NAME }}
  CONTAINER_APP_NAME_BACKEND: ${{ secrets.CONTAINER_APP_NAME_BACKEND }}
  CONTAINER_APP_NAME_FRONTEND: ${{ secrets.CONTAINER_APP_NAME_FRONTEND }}
  CONTAINER_APP_ENVIRONMENT: ${{ secrets.CONTAINER_APP_ENVIRONMENT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="latest"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/intracker-backend:${{ steps.extract_version.outputs.tag }}
            ${{ env.ACR_NAME }}.azurecr.io/intracker-backend:latest
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/intracker-backend:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/intracker-backend:buildcache,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          platforms: linux/amd64
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
            VITE_SIGNALR_URL=${{ secrets.VITE_SIGNALR_URL }}
            VITE_APP_NAME=InTracker
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:${{ steps.extract_version.outputs.tag }}
            ${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:latest
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:buildcache,mode=max

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Backend Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME_BACKEND }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/intracker-backend:${{ steps.extract_version.outputs.tag }}

      - name: Update Frontend Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME_FRONTEND }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:${{ steps.extract_version.outputs.tag }}

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Image:** ${{ env.ACR_NAME }}.azurecr.io/intracker-backend:${{ steps.extract_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Image:** ${{ env.ACR_NAME }}.azurecr.io/intracker-frontend:${{ steps.extract_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
